<!DOCTYPE html>
<html lang="vi" class="antialiased">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>IQO ULTRA 2026 - Virtual Exam Room</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#f5f5f7">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<!-- Import Data (File data.js b·∫°n ƒë√£ l∆∞u) -->
<script src="data.js"></script>

<style>
    :root {
        --bg: #f5f5f7; --card: #ffffff; --text: #1d1d1f; --sub: #86868b;
        --accent: #0071e3; --success: #34c759; --danger: #ff3b30; --gold: #F5A623;
        --glass: rgba(255, 255, 255, 0.75);
        --font-main: 'Inter', system-ui, -apple-system, sans-serif;
    }
    .dark {
        --bg: #000000; --card: #1c1c1e; --text: #f5f5f7; --sub: #98989d;
        --accent: #0a84ff; --glass: rgba(28, 28, 30, 0.75);
    }
    
    body { font-family: var(--font-main); background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; transition: background 0.3s ease; }
    
    /* MacOS Tahoe Glass */
    .glass-panel { background: var(--glass); backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%); border: 1px solid rgba(128,128,128,0.1); box-shadow: 0 4px 24px rgba(0,0,0,0.04); }
    
    /* Components */
    .btn { transition: all 0.2s cubic-bezier(0.25,1,0.5,1); cursor: pointer; user-select: none; }
    .btn:active { transform: scale(0.96); }
    
    .tier-badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; }
    .tier-free { background: #e5e5ea; color: #8e8e93; }
    .tier-pro { background: linear-gradient(135deg, #0071e3, #4facfe); color: white; box-shadow: 0 2px 8px rgba(0,113,227,0.3); }
    .tier-zero { background: linear-gradient(135deg, #FFD700, #FDB931); color: black; box-shadow: 0 2px 10px rgba(253, 185, 49, 0.4); border: 1px solid rgba(255,255,255,0.5); }

    .option-row { transition: 0.2s; border: 1.5px solid transparent; }
    .option-row:hover { background: rgba(128,128,128,0.05); }
    .option-row.selected { background: rgba(0,113,227,0.08); border-color: var(--accent); }
    .option-row.strike { opacity: 0.5; text-decoration: line-through; pointer-events: none; filter: grayscale(100%); }
    
    /* Images inside questions */
    .block-img { display: block; max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(128,128,128,0.2); }
    .inline-img { display: inline-block; vertical-align: middle; max-height: 24px; margin: 0 4px; }
    
    /* Toast Notification */
    #toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(0,0,0,0.8); color: white; padding: 10px 24px; border-radius: 50px; font-size: 13px; font-weight: 600; z-index: 100; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(10px); display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    #toast-box.show { transform: translateX(-50%) translateY(0); }

    /* Animations */
    @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
    @keyframes confetti { 0% { transform: translateY(0) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; } }
    .enter { animation: slideUp 0.4s ease-out forwards; }
    
    /* Utilities */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .focus-mode .sidebar, .focus-mode header { display: none !important; }
    .focus-mode #content-area { padding: 40px !important; max-width: 800px; margin: 0 auto; }
</style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Toast -->
    <div id="toast-box">Initializing Quantum Shield...</div>

    <!-- Confetti Container -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-[100] hidden"></div>

    <!-- Security Modal (Quantum Shield) -->
    <div id="key-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-xl hidden">
        <div class="glass-panel w-[90%] max-w-sm rounded-3xl p-8 shadow-2xl scale-100 enter text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl shadow-inner">üõ°Ô∏è</div>
            <h3 class="text-xl font-bold mb-1">IQO QUANTUM SHIELD</h3>
            <p class="text-xs text-[var(--sub)] mb-6">H·ªá th·ªëng b·∫£o v·ªá m√£ h√≥a l∆∞·ª£ng t·ª≠ 2026</p>
            
            <input type="text" id="key-input" placeholder="XXXX-XXXX-XXXX" class="w-full p-4 rounded-xl bg-[rgba(128,128,128,0.08)] text-center font-mono text-sm uppercase mb-4 focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition-all" spellcheck="false">
            
            <button onclick="verifyKey()" id="verify-btn" class="w-full py-3.5 rounded-xl bg-[var(--text)] text-[var(--bg)] font-bold btn mb-3 shadow-lg hover:shadow-xl relative overflow-hidden">
                <span class="relative z-10">X√ÅC TH·ª∞C KEY</span>
            </button>
            <button onclick="useFree()" class="text-xs text-[var(--sub)] hover:text-[var(--text)] underline decoration-dotted">Ti·∫øp t·ª•c v·ªõi b·∫£n Mi·ªÖn ph√≠</button>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar w-full md:w-[280px] glass-panel border-r-0 md:border-r flex flex-col z-40 shrink-0 h-16 md:h-full fixed md:relative bottom-0 md:bottom-auto order-2 md:order-1 transition-all">
        <div class="h-16 hidden md:flex items-center px-6 gap-3 select-none">
            <div class="flex gap-1.5 absolute top-4 left-4">
                <div class="w-3 h-3 rounded-full bg-[#FF5F57] cursor-pointer" onclick="resetApp()" title="Reset Data"></div>
                <div class="w-3 h-3 rounded-full bg-[#FEBC2E] cursor-pointer" onclick="toggleDarkMode()" title="Dark Mode"></div>
                <div class="w-3 h-3 rounded-full bg-[#28C840] cursor-pointer" onclick="toggleFocusMode()" title="Zen Mode"></div>
            </div>
            <div class="ml-auto text-right">
                <div class="font-bold text-sm tracking-tight">IQO ULTRA</div>
                <div class="text-[10px] text-[var(--sub)]" id="user-tier-display">Loading...</div>
            </div>
        </div>
        
        <div class="px-4 py-2 hidden md:block">
            <input type="text" id="search-bar" placeholder="üîç T√¨m ki·∫øm ƒë·ªÅ thi..." class="w-full bg-[rgba(128,128,128,0.1)] rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-[var(--accent)]">
        </div>

        <nav class="flex-1 overflow-y-auto p-2 space-y-1 flex md:block flex-row items-center justify-around md:justify-start" id="nav-list"></nav>
        
        <!-- Tools & Scratchpad -->
        <div class="p-4 border-t border-[rgba(128,128,128,0.1)] hidden md:block">
            <div class="flex justify-between text-xs mb-2 text-[var(--sub)]">
                <span>Nh√°p nhanh (Auto-save)</span>
                <button onclick="clearScratchpad()" class="hover:text-red-500">X√≥a</button>
            </div>
            <textarea id="scratchpad" class="w-full h-24 bg-[rgba(128,128,128,0.05)] rounded-lg p-2 text-xs resize-none focus:outline-none focus:ring-1 focus:ring-[var(--accent)]" placeholder="Ghi ch√∫ c√¥ng th·ª©c..."></textarea>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden order-1 md:order-2 bg-[var(--bg)]">
        <!-- Header -->
        <header class="h-14 glass-panel border-b border-[rgba(128,128,128,0.1)] flex items-center justify-between px-6 shrink-0 z-30 transition-all">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="font-bold text-sm truncate max-w-[200px]">T·ªïng quan</h2>
                <div id="cheating-warning" class="hidden text-xs font-bold text-red-500 bg-red-100 px-2 py-1 rounded animate-pulse">‚ö†Ô∏è PH√ÅT HI·ªÜN R·ªúI TAB</div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="adjustFontSize(-1)" class="w-8 h-8 rounded-lg hover:bg-black/5 font-serif text-xs">A-</button>
                <button onclick="adjustFontSize(1)" class="w-8 h-8 rounded-lg hover:bg-black/5 font-serif text-sm font-bold">A+</button>
                <div id="timer" class="hidden font-mono text-sm font-bold bg-[var(--accent)] text-white px-3 py-1 rounded-md shadow-lg shadow-blue-500/30">00:00</div>
                <button onclick="submitExam()" id="submit-btn" class="hidden px-5 py-1.5 bg-[var(--success)] text-white rounded-full text-xs font-bold btn shadow-lg">N·ªòP B√ÄI</button>
                <button onclick="toggleKeyModal()" class="w-8 h-8 rounded-full bg-[rgba(128,128,128,0.1)] flex items-center justify-center btn" title="T√†i kho·∫£n"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></button>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="h-1 w-full bg-[rgba(128,128,128,0.1)]">
            <div id="progress-bar" class="h-full bg-[var(--accent)] w-0 transition-all duration-300"></div>
        </div>

        <!-- Viewport -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24 md:pb-8 relative">
            <!-- Content Injected Here -->
        </div>
        
        <!-- Explanation Overlay (Zero Tier) -->
        <div id="expl-modal" class="absolute inset-0 bg-[var(--bg)] z-50 transform translate-y-full transition-transform duration-300 flex flex-col glass-panel">
            <div class="h-14 border-b flex items-center justify-between px-6 shrink-0 bg-[var(--glass)]">
                <div class="flex items-center gap-2">
                    <span class="text-xl">üí°</span>
                    <h3 class="font-bold">L·ªùi gi·∫£i chi ti·∫øt</h3>
                </div>
                <button onclick="closeExpl()" class="w-8 h-8 rounded-full bg-[rgba(128,128,128,0.1)] flex items-center justify-center hover:bg-black/10 transition">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 md:p-10" id="expl-content"></div>
        </div>
    </main>

<script>
// --- CORE SYSTEM & STATE ---
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

let STATE = {
    tier: 'free', // free, pro, zero
    exam: null,
    answers: {},
    flags: new Set(),
    timer: null,
    time: 0,
    fontSize: 100,
    cheatCount: 0
};

// --- SOUND ENGINE (Base64 Beeps to avoid external requests) ---
const SOUNDS = {
    click: new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..."), // Placeholder (Real browser click usually silent or system)
    success: new Audio("data:audio/wav;base64,UklGRCQBAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQBAAAAA..."), 
    // In real prod, use real files. For this demo, we use visual feedback mostly.
};
const playSound = (type) => { /* Placeholder for sound logic */ };

// --- QUANTUM SHIELD SECURITY (Web Crypto API) ---
const QuantumGuard = {
    _str2buf: (str) => new TextEncoder().encode(str),
    _buf2hex: (buf) => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''),
    async hash(key) {
        if(!window.crypto || !window.crypto.subtle) return "insecure_env";
        const salt = this._str2buf(SECURE_VAULT._salt);
        const keyMaterial = await crypto.subtle.importKey("raw", this._str2buf(key), { name: "PBKDF2" }, false, ["deriveBits", "deriveKey"]);
        const derivedKey = await crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
            keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]
        );
        const exported = await crypto.subtle.exportKey("raw", derivedKey);
        return this._buf2hex(exported);
    }
};

const verifyKey = async () => {
    const input = $('#key-input').value.trim();
    const btn = $('#verify-btn');
    if (!input) return useFree();

    const originalText = btn.innerText;
    btn.innerHTML = `<span class="animate-pulse">ƒêANG GI·∫¢I M√É KH·ªêI...</span>`;
    btn.disabled = true;

    try {
        const inputHash = await QuantumGuard.hash(input);
        
        if (SECURE_VAULT._ledger.zero.includes(inputHash)) {
            activateTier('zero');
            showToast("üîì ƒê√£ m·ªü kh√≥a ch·∫ø ƒë·ªô ZERO GOD MODE");
            playSound('success');
        } else if (SECURE_VAULT._ledger.pro.includes(inputHash)) {
            activateTier('pro');
            showToast("üîì ƒê√£ k√≠ch ho·∫°t b·∫£n PRO");
        } else {
            await new Promise(r => setTimeout(r, 1200)); // Anti-bruteforce delay
            alert('‚õî M√£ k√≠ch ho·∫°t kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.');
            $('#key-input').value = '';
            $('#key-input').focus();
        }
    } catch (e) {
        console.error(e);
        alert("L·ªói m√¥i tr∆∞·ªùng b·∫£o m·∫≠t. Vui l√≤ng d√πng tr√¨nh duy·ªát hi·ªán ƒë·∫°i (Chrome/Safari).");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

const useFree = () => { activateTier('free'); showToast("ƒêang d√πng b·∫£n Mi·ªÖn ph√≠"); };

const activateTier = (tier) => {
    STATE.tier = tier;
    localStorage.setItem('iqo_session_token', btoa(tier + SECURE_VAULT._salt)); // Obfuscated storage
    $('#key-modal').classList.add('hidden');
    updateUI();
    initApp();
};

const restoreSession = () => {
    const token = localStorage.getItem('iqo_session_token');
    if (!token) return;
    try {
        const decoded = atob(token);
        if (decoded.includes('zero')) STATE.tier = 'zero';
        else if (decoded.includes('pro')) STATE.tier = 'pro';
        else STATE.tier = 'free';
    } catch(e) { STATE.tier = 'free'; }
};

const toggleKeyModal = () => $('#key-modal').classList.remove('hidden');

// --- UI & FEATURES ---
const updateUI = () => {
    const badges = {
        free: '<span class="tier-badge tier-free">Basic</span>',
        pro: '<span class="tier-badge tier-pro">PRO Member</span>',
        zero: '<span class="tier-badge tier-zero">ZERO Elite</span>'
    };
    $('#user-tier-display').innerHTML = badges[STATE.tier];
    if(STATE.tier === 'free') $('#key-modal').classList.remove('hidden');
};

const initApp = () => {
    renderDashboard();
    renderNav();
    loadScratchpad();
    // Cheating Detection
    document.addEventListener("visibilitychange", () => {
        if(document.hidden && STATE.exam) {
            STATE.cheatCount++;
            $('#cheating-warning').innerText = `‚ö†Ô∏è C·∫¢NH B√ÅO R·ªúI TAB (${STATE.cheatCount})`;
            $('#cheating-warning').classList.remove('hidden');
        }
    });
};

const renderNav = () => {
    $('#nav-list').innerHTML = EXAM_DATA.map(e => `
        <div onclick="startExam('${e.id}')" class="p-3 rounded-xl cursor-pointer hover:bg-[rgba(128,128,128,0.05)] flex items-center gap-3 w-full group transition-all">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-xs shadow-sm group-hover:scale-110 transition-transform ${e.id.includes('hoa')?'bg-blue-100 text-blue-600':'bg-purple-100 text-purple-600'}">${e.title[0]}</div>
            <div class="hidden md:block text-left min-w-0">
                <div class="text-xs font-bold truncate w-40 group-hover:text-[var(--accent)] transition-colors">${e.title}</div>
                <div class="text-[10px] text-[var(--sub)]">${e.questions.length} c√¢u ‚Ä¢ ${e.time}p</div>
            </div>
        </div>
    `).join('');
};

const renderDashboard = () => {
    $('#page-title').innerText = "Th∆∞ vi·ªán ƒë·ªÅ thi";
    $('#timer').classList.add('hidden');
    $('#submit-btn').classList.add('hidden');
    $('#cheating-warning').classList.add('hidden');
    
    $('#content-area').innerHTML = `
        <div class="max-w-5xl mx-auto enter">
            <div class="mb-8 p-6 glass-panel rounded-3xl flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-900">
                <div>
                    <h1 class="text-2xl font-bold mb-1">Ch√†o m·ª´ng tr·ªü l·∫°i!</h1>
                    <p class="text-xs text-[var(--sub)]">B·∫°n ƒëang ·ªü c·∫•p ƒë·ªô: <span class="font-bold">${STATE.tier.toUpperCase()}</span>. S·∫µn s√†ng chinh ph·ª•c ki·∫øn th·ª©c ch∆∞a?</p>
                </div>
                <div class="text-4xl">üöÄ</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                ${EXAM_DATA.map(e => `
                    <div onclick="startExam('${e.id}')" class="glass-panel p-6 rounded-2xl cursor-pointer hover:translate-y-[-4px] transition-all relative overflow-hidden group border-t-4 ${e.id.includes('hoa')?'border-blue-500':'border-purple-500'}">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[10px] font-extrabold uppercase tracking-widest px-2 py-1 rounded bg-[rgba(128,128,128,0.1)]">${e.category.toUpperCase()}</span>
                            <span class="text-[10px] font-mono opacity-50">ID: ${e.id.split('-')[1]}</span>
                        </div>
                        <h3 class="text-lg font-bold mb-2 leading-tight">${e.title}</h3>
                        <p class="text-xs text-[var(--sub)] mb-6 line-clamp-2">${e.subtitle}</p>
                        <div class="flex items-center justify-between mt-auto">
                            <div class="text-xs font-bold text-[var(--accent)] group-hover:underline">B·∫Øt ƒë·∫ßu thi</div>
                            <svg class="w-4 h-4 text-[var(--accent)] transform group-hover:translate-x-1 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
};

// --- EXAM ENGINE ---
const startExam = (id) => {
    STATE.exam = EXAM_DATA.find(e => e.id === id);
    STATE.answers = {};
    STATE.flags.clear();
    STATE.time = STATE.exam.time * 60;
    STATE.cheatCount = 0;
    
    // Auto-load previous progress
    const saved = JSON.parse(localStorage.getItem('iqo_prog_' + id));
    if(saved) {
        if(confirm('Ph√°t hi·ªán b√†i l√†m ch∆∞a xong. B·∫°n mu·ªën ti·∫øp t·ª•c?')) {
            STATE.answers = saved.answers;
            STATE.time = saved.time;
        } else {
            localStorage.removeItem('iqo_prog_' + id);
        }
    }

    // UI Setup
    $('#page-title').innerText = STATE.exam.title;
    $('#timer').classList.remove('hidden');
    $('#submit-btn').classList.remove('hidden');
    $('#cheating-warning').classList.add('hidden');
    
    renderQuestions();
    startTimer();
    showToast(`üèÅ B·∫Øt ƒë·∫ßu l√†m b√†i: ${STATE.exam.title}`);
};

const renderQuestions = () => {
    const qHTML = STATE.exam.questions.map((q, i) => `
        <div class="glass-panel p-6 md:p-8 rounded-3xl mb-6 relative group transition-all" id="q-${i}">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <span class="w-8 h-8 rounded-full bg-[rgba(128,128,128,0.1)] flex items-center justify-center text-xs font-bold font-mono">${i+1}</span>
                    <span class="text-[10px] font-mono text-[var(--sub)] opacity-60">ID: ${q.uid}</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleFlag(${i})" class="p-2 rounded-full hover:bg-[rgba(255,165,0,0.1)] text-gray-300 transition" id="flag-btn-${i}">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>
                    </button>
                    ${STATE.tier === 'zero' ? `<button onclick="showExpl(${i})" class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 text-[10px] font-bold hover:scale-105 transition">XEM L·ªúI GI·∫¢I</button>` : ''}
                </div>
            </div>
            
            <div class="text-[15px] font-medium mb-6 leading-relaxed select-text">${q.text}</div>
            
            ${renderQuestionBody(q, i)}
        </div>
    `).join('');
    
    $('#content-area').innerHTML = `<div class="max-w-3xl mx-auto">${qHTML}</div>`;
    
    // Restore UI state
    Object.keys(STATE.answers).forEach(k => {
        const idx = parseInt(k);
        const val = STATE.answers[idx];
        const q = STATE.exam.questions[idx];
        if(q.type==='choice') {
            const el = $(`#opt-${idx}-${val}`);
            if(el) selectAns(idx, val, el, false);
        } else if(q.type==='input') {
            $(`#inp-${idx}`).value = val;
        }
    });
    updateProgress();
};

const renderQuestionBody = (q, i) => {
    if(q.type === 'choice') {
        return `<div class="grid gap-3">
            ${q.options.map((opt, oid) => `
                <div id="opt-${i}-${oid}" onclick="selectAns(${i}, ${oid}, this)" oncontextmenu="toggleStrike(event, this)" class="option-row p-4 rounded-xl cursor-pointer flex items-center gap-4 group/opt">
                    <div class="w-6 h-6 rounded-full border-2 border-[var(--sub)] flex items-center justify-center text-[10px] font-bold opt-idx transition-all group-hover/opt:border-[var(--accent)] shrink-0">${String.fromCharCode(65+oid)}</div>
                    <div class="text-sm select-none">${opt}</div>
                </div>
            `).join('')}
        </div>`;
    } else if(q.type === 'input') {
        return `<input id="inp-${i}" onchange="inputAns(${i}, this.value)" type="text" placeholder="${q.placeholder}" class="w-full p-4 rounded-xl bg-[rgba(128,128,128,0.05)] border border-transparent focus:bg-[var(--card)] focus:border-[var(--accent)] focus:ring-4 focus:ring-blue-500/10 outline-none text-sm font-mono transition shadow-inner">`;
    } else {
        return `<div class="space-y-3">
           ${q.options.map((opt, oid) => `
                <div class="flex justify-between items-center p-3 rounded-lg bg-[rgba(128,128,128,0.02)]">
                    <span class="text-sm w-3/4">${opt}</span>
                    <div class="flex gap-2">
                        <button onclick="selectGroup(${i}, ${oid}, true, this)" class="w-8 h-8 rounded-lg border text-xs font-bold hover:bg-[var(--accent)] hover:text-white transition">ƒê</button>
                        <button onclick="selectGroup(${i}, ${oid}, false, this)" class="w-8 h-8 rounded-lg border text-xs font-bold hover:bg-[var(--accent)] hover:text-white transition">S</button>
                    </div>
                </div>
           `).join('')}
        </div>`;
    }
};

// --- INTERACTION LOGIC ---
const selectAns = (qIdx, optIdx, el, save=true) => {
    if(el.classList.contains('strike')) return;
    STATE.answers[qIdx] = optIdx;
    
    const parent = el.parentElement;
    Array.from(parent.children).forEach(c => {
        c.classList.remove('selected');
        c.querySelector('.opt-idx').className = 'w-6 h-6 rounded-full border-2 border-[var(--sub)] flex items-center justify-center text-[10px] font-bold opt-idx transition-all group-hover/opt:border-[var(--accent)] shrink-0';
    });
    el.classList.add('selected');
    el.querySelector('.opt-idx').className = 'w-6 h-6 rounded-full border-2 border-[var(--accent)] bg-[var(--accent)] text-white flex items-center justify-center text-[10px] font-bold opt-idx transition-all shrink-0 shadow-lg shadow-blue-500/40';
    
    if(save) saveProgress();
    updateProgress();
};

const inputAns = (qIdx, val) => {
    STATE.answers[qIdx] = val;
    saveProgress();
    updateProgress();
};

const selectGroup = (qIdx, oIdx, val, el) => {
    if(!STATE.answers[qIdx]) STATE.answers[qIdx] = {};
    STATE.answers[qIdx][oIdx] = val;
    Array.from(el.parentElement.children).forEach(c => c.classList.remove('bg-[var(--accent)]', 'text-white'));
    el.classList.add('bg-[var(--accent)]', 'text-white');
    saveProgress();
};

const toggleStrike = (e, el) => {
    e.preventDefault();
    el.classList.toggle('strike');
};

const toggleFlag = (i) => {
    const btn = $(`#flag-btn-${i}`);
    if(STATE.flags.has(i)) {
        STATE.flags.delete(i);
        btn.classList.remove('text-[var(--gold)]');
    } else {
        STATE.flags.add(i);
        btn.classList.add('text-[var(--gold)]');
    }
};

const saveProgress = () => {
    localStorage.setItem('iqo_prog_' + STATE.exam.id, JSON.stringify({
        answers: STATE.answers,
        time: STATE.time
    }));
};

const updateProgress = () => {
    const total = STATE.exam.questions.length;
    const done = Object.keys(STATE.answers).length;
    const pct = (done / total) * 100;
    $('#progress-bar').style.width = `${pct}%`;
};

// --- TIMER & SUBMIT ---
const startTimer = () => {
    if(STATE.timer) clearInterval(STATE.timer);
    const display = $('#timer');
    STATE.timer = setInterval(() => {
        STATE.time--;
        const m = Math.floor(STATE.time/60), s = STATE.time%60;
        display.innerText = `${m}:${s<10?'0'+s:s}`;
        if(STATE.time <= 300) display.classList.add('bg-red-500', 'animate-pulse');
        if(STATE.time <= 0) submitExam();
    }, 1000);
};

const submitExam = () => {
    if(!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?')) return;
    clearInterval(STATE.timer);
    let score = 0;
    
    STATE.exam.questions.forEach((q, i) => {
        const ans = STATE.answers[i];
        let correct = false;
        
        // Advanced grading logic
        if(q.type === 'choice') correct = (ans === q.correct);
        else if(q.type === 'input') correct = (ans && ans.toString().trim().toLowerCase() == q.correct.toString().trim().toLowerCase());
        else if(q.type === 'group') correct = true; // Simplified for demo
        
        if(correct) score++;
        
        // UI Feedback
        const card = $(`#q-${i}`);
        card.style.borderLeft = `4px solid ${correct ? 'var(--success)' : 'var(--danger)'}`;
        card.classList.add(correct ? 'bg-green-50/50' : 'bg-red-50/50', 'dark:bg-green-900/10', 'dark:bg-red-900/10');
        
        if(STATE.tier !== 'free') {
            const expl = document.createElement('div');
            expl.className = "mt-4 p-4 rounded-xl bg-[rgba(128,128,128,0.05)] text-sm border border-[rgba(128,128,128,0.1)]";
            expl.innerHTML = `<b class="${correct?'text-[var(--success)]':'text-[var(--danger)]'}">${correct?'CH√çNH X√ÅC':'SAI R·ªíI'}</b>. ${q.explanation || 'Kh√¥ng c√≥ l·ªùi gi·∫£i.'}`;
            card.appendChild(expl);
        }
    });
    
    // Confetti Effect if High Score
    if(score / STATE.exam.questions.length > 0.8) fireConfetti();
    
    localStorage.removeItem('iqo_prog_' + STATE.exam.id);
    alert(`K·∫øt qu·∫£: ${score}/${STATE.exam.questions.length}. ${STATE.tier === 'free' ? 'N√¢ng c·∫•p PRO ƒë·ªÉ xem gi·∫£i chi ti·∫øt!' : ''}`);
    $('#submit-btn').classList.add('hidden');
    $('header').scrollIntoView();
};

// --- UTILS & FEATURES ---
const fireConfetti = () => {
    const c = $('#confetti-container');
    c.classList.remove('hidden');
    c.innerHTML = Array(50).fill(0).map(() => 
        `<div style="position:absolute; left:${Math.random()*100}vw; top:-10px; width:10px; height:10px; background:hsl(${Math.random()*360},100%,50%); animation: confetti ${2+Math.random()*3}s linear infinite;"></div>`
    ).join('');
    setTimeout(() => c.classList.add('hidden'), 5000);
};

const showExpl = (i) => {
    const q = STATE.exam.questions[i];
    $('#expl-content').innerHTML = `
        <div class="mb-6"><span class="text-xs font-bold text-[var(--sub)] uppercase tracking-wider">C√¢u h·ªèi</span><p class="text-lg font-medium mt-1">${q.text}</p></div>
        <div class="p-6 rounded-2xl bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 border border-blue-100 dark:border-blue-800 shadow-inner">
            <h4 class="font-bold text-[var(--accent)] mb-3 flex items-center gap-2">üéØ L·ªùi gi·∫£i chi ti·∫øt</h4>
            <div class="text-sm leading-relaxed text-[var(--text)] opacity-90">${q.explanation}</div>
        </div>
    `;
    $('#expl-modal').classList.remove('translate-y-full');
};
const closeExpl = () => $('#expl-modal').classList.add('translate-y-full');

const showToast = (msg) => {
    const t = $('#toast-box');
    t.innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
};

// --- SETTINGS ---
const toggleDarkMode = () => {
    document.documentElement.classList.toggle('dark');
    showToast(document.documentElement.classList.contains('dark') ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode");
};
const toggleFocusMode = () => {
    document.body.classList.toggle('focus-mode');
    showToast("Zen Mode Toggled");
};
const adjustFontSize = (d) => {
    STATE.fontSize += d * 5;
    $('#content-area').style.fontSize = `${STATE.fontSize}%`;
};
const clearScratchpad = () => { $('#scratchpad').value = ''; localStorage.removeItem('iqo_scratch'); };
const loadScratchpad = () => { 
    const v = localStorage.getItem('iqo_scratch'); 
    if(v) $('#scratchpad').value = v; 
    $('#scratchpad').addEventListener('input', e => localStorage.setItem('iqo_scratch', e.target.value));
};
const resetApp = () => {
    if(confirm('Reset to√†n b·ªô d·ªØ li·ªáu ·ª©ng d·ª•ng?')) { localStorage.clear(); location.reload(); }
};

// --- KEYBOARD SHORTCUTS ---
document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') closeExpl();
    if(e.ctrlKey && e.key === 'Enter') submitExam();
});

// START
restoreSession();
if(STATE.tier !== 'free') $('#key-modal').classList.add('hidden');
</script>
</body>
</html>
