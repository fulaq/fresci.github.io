<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>IQO - Khoa H·ªçc T·ª± Do</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Serif:wght@400;600&display=swap" rel="stylesheet">
<script src="data.js"></script>
<style>
:root{--bg:#f5f5f7;--sidebar:#fbfbfd;--card:#ffffff;--text:#1d1d1f;--glass:rgba(255,255,255,0.72);--border:rgba(0,0,0,0.06);--accent:#0071e3;--shadow:0 4px 12px rgba(0,0,0,0.03);--correct:#34c759;--wrong:#ff3b30}
.dark{--bg:#1e1e1e;--sidebar:#2c2c2e;--card:#3a3a3c;--text:#f5f5f7;--glass:rgba(44,44,46,0.72);--border:rgba(255,255,255,0.1);--accent:#0a84ff;--shadow:0 4px 12px rgba(0,0,0,0.2)}
body{font-family:-apple-system,BlinkMacSystemFont,'Inter',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;transition:background 0.3s,color 0.3s}
.glass-panel{background:var(--glass);backdrop-filter:blur(25px);-webkit-backdrop-filter:blur(25px);border-bottom:1px solid var(--border)}
.sidebar{width:260px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:transform 0.3s cubic-bezier(0.25,1,0.5,1)}
.card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);border:1px solid var(--border);transition:transform 0.2s}
.exam-font{font-family:'Noto Serif',serif;font-size:1.1rem;line-height:1.7;white-space:normal}
.inline-img{display:inline-block;vertical-align:middle;margin:0 4px;max-height:1.5em;width:auto}
.block-img{display:block;max-width:100%;margin:12px auto;border-radius:8px;border:1px solid var(--border)}
.btn-apple{background:var(--accent);color:#fff;border-radius:8px;padding:6px 16px;font-size:13px;font-weight:500;transition:0.2s}
.btn-apple:active{opacity:0.8;transform:scale(0.98)}
.nav-item{padding:8px 12px;margin:2px 10px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text);transition:0.2s}
.nav-item:hover{background:rgba(0,0,0,0.05)}
.nav-item.active{background:rgba(0,113,227,0.12);color:var(--accent);font-weight:600}
.q-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:10px}
.q-cell{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:500;cursor:pointer;background:var(--bg);border:1px solid var(--border);transition:0.2s}
.q-cell.done{background:var(--accent);color:#fff;border-color:var(--accent)}
.q-cell.correct{background:var(--correct);color:#fff;border-color:var(--correct)}
.q-cell.wrong{background:var(--wrong);color:#fff;border-color:var(--wrong)}
.q-cell.flagged{border-color:#ff9f0a;color:#ff9f0a;background:rgba(255,159,10,0.1)}
.option-row{display:flex;padding:12px;border:1px solid var(--border);border-radius:10px;margin-top:8px;cursor:pointer;transition:0.2s;align-items:center}
.option-row:hover{background:var(--bg)}
.option-row.selected{border-color:var(--accent);background:rgba(0,113,227,0.05)}
.option-row.correct{border-color:var(--correct);background:rgba(52,199,89,0.1)}
.option-row.wrong{border-color:var(--wrong);background:rgba(255,59,48,0.1)}
.input-field{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);margin-top:8px;font-size:14px}
.input-field:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,113,227,0.2)}
.hidden{display:none!important}
@media(max-width:768px){.sidebar{position:fixed;height:100%;z-index:50;transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}}
::-webkit-scrollbar{width:0px}
</style>
</head>
<body>

<div class="flex h-full">
    <aside class="sidebar" id="sidebar">
        <div class="h-12 flex items-center px-4 gap-2 mt-2">
            <div class="flex gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><div class="w-3 h-3 rounded-full bg-yellow-500"></div><div class="w-3 h-3 rounded-full bg-green-500"></div></div>
        </div>
        <div class="px-4 mb-4 flex items-center gap-3">
            <!-- SVG Logo -->
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="32" height="32" rx="8" fill="url(#paint0_linear)"/>
                <path d="M16 8L24 24H8L16 8Z" fill="white"/>
                <defs><linearGradient id="paint0_linear" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse"><stop stop-color="#007AFF"/><stop offset="1" stop-color="#0055B3"/></linearGradient></defs>
            </svg>
            <div><div class="text-lg font-semibold tracking-tight">IQO</div><div class="text-[10px] opacity-50 font-medium">KHOA H·ªåC T·ª∞ DO</div></div>
        </div>
        <nav class="flex-1 overflow-y-auto">
            <div class="px-4 mb-1 text-[11px] font-bold opacity-40 uppercase">Th∆∞ vi·ªán</div>
            <div class="nav-item active" onclick="switchView('dashboard')"><span>ÙÄéû</span> T·ªïng quan</div>
            <div class="nav-item" onclick="showModeSelection('thpt-hoa-338-final')"><span>ÙÄàå</span> ƒê·ªÅ H√≥a 0338</div>
        </nav>
        <div class="p-4 border-t border-[var(--border)]">
            <div class="flex items-center justify-between bg-[var(--bg)] p-2 rounded-lg cursor-pointer" onclick="toggleTheme()">
                <span class="text-xs font-medium ml-1">Giao di·ªán</span>
                <div class="w-8 h-4 bg-gray-300 rounded-full relative transition duration-300 dark:bg-green-500"><div class="w-3 h-3 bg-white rounded-full absolute top-0.5 left-0.5 transition duration-300 transform dark:translate-x-4"></div></div>
            </div>
        </div>
    </aside>
    <div class="fixed inset-0 bg-black/20 z-40 hidden md:hidden backdrop-blur-sm" id="overlay" onclick="toggleSidebar()"></div>

    <main class="flex-1 flex flex-col relative min-w-0 bg-[var(--bg)]">
        <header class="glass-panel sticky top-0 z-30 h-12 flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden text-xl opacity-70">ÙÄÜä</button>
                <h2 id="page-title" class="font-semibold text-sm opacity-80">T·ªïng quan</h2>
            </div>
            <div id="exam-controls" class="hidden flex items-center gap-3">
                <div class="text-xs font-mono font-medium opacity-60" id="timer">00:00</div>
                <button onclick="submitExam()" class="btn-apple" id="submit-btn">N·ªôp b√†i</button>
            </div>
        </header>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="flex-1 overflow-y-auto p-8">
            <div class="max-w-4xl mx-auto">
                <div class="mb-8 text-center"><h1 class="text-3xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i.</h1><p class="text-sm opacity-60">S·∫µn s√†ng chinh ph·ª•c ki·∫øn th·ª©c h√¥m nay?</p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card p-5 cursor-pointer hover:bg-[var(--card)]" onclick="showModeSelection('thpt-hoa-338-final')">
                        <div class="flex justify-between items-start mb-3"><span class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-100 text-blue-600 uppercase">M·ªõi nh·∫•t</span><span class="text-xs opacity-40">50 ph√∫t</span></div>
                        <h3 class="text-lg font-semibold mb-1">H√≥a H·ªçc - M√£ ƒë·ªÅ 0338</h3>
                        <p class="text-xs opacity-50 mb-4">THPT QG 2025 ‚Ä¢ Chu·∫©n c·∫•u tr√∫c</p>
                        <div class="text-xs font-medium text-[var(--accent)]">L√†m b√†i ngay ÙÄÜä</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode Selection Modal -->
        <div id="mode-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
            <div class="card p-6 w-96 max-w-[90%] animate-scale">
                <h3 class="text-lg font-bold mb-2">Ch·ªçn ch·∫ø ƒë·ªô</h3>
                <p class="text-sm opacity-60 mb-6">B·∫°n mu·ªën l√†m b√†i thi th·ª≠ hay luy·ªán t·∫≠p t·ª´ng c√¢u?</p>
                <div class="flex flex-col gap-3">
                    <button onclick="startExam('exam')" class="btn-apple w-full py-3 bg-blue-600 hover:bg-blue-700">‚è± Thi th·ª≠ (C√≥ t√≠nh gi·ªù)</button>
                    <button onclick="startExam('practice')" class="btn-apple w-full py-3 bg-gray-500 hover:bg-gray-600">üìñ Luy·ªán t·∫≠p (Bi·∫øt ƒë√°p √°n ngay)</button>
                    <button onclick="$('mode-modal').classList.add('hidden')" class="text-xs text-center mt-2 opacity-50 hover:opacity-100">H·ªßy b·ªè</button>
                </div>
            </div>
        </div>

        <!-- Exam View -->
        <div id="exam-view" class="hidden flex-1 flex h-full overflow-hidden">
            <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="question-container"></div>
            <div class="w-64 bg-[var(--sidebar)] border-l border-[var(--border)] flex flex-col hidden lg:flex shrink-0">
                <div class="p-3 border-b border-[var(--border)] text-xs font-semibold opacity-60 text-center">B·∫£ng c√¢u h·ªèi</div>
                <div class="flex-1 overflow-y-auto"><div class="q-grid" id="palette"></div></div>
            </div>
        </div>
    </main>
</div>

<script>
let currentExam=null, timerInterval, userAnswers={}, flaggedQuestions=new Set(), currentMode='exam', selectedExamId=null;
const $=id=>document.getElementById(id);

function init(){
    if(localStorage.getItem('theme')==='dark') document.documentElement.classList.add('dark');
}

function toggleTheme(){
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');
}

function toggleSidebar(){
    $('sidebar').classList.toggle('open');
    $('overlay').classList.toggle('hidden');
}

function switchView(view){
    if(view==='dashboard'){
        $('dashboard-view').classList.remove('hidden');
        $('exam-view').classList.add('hidden');
        $('exam-controls').classList.add('hidden');
        $('page-title').innerText="T·ªïng quan";
        clearInterval(timerInterval);
    }
}

function showModeSelection(id){
    selectedExamId = id;
    $('mode-modal').classList.remove('hidden');
}

function startExam(mode){
    currentMode = mode;
    $('mode-modal').classList.add('hidden');
    currentExam = EXAM_DATA.find(e=>e.id===selectedExamId);
    
    $('dashboard-view').classList.add('hidden');
    $('exam-view').classList.remove('hidden');
    $('exam-view').classList.add('flex');
    $('exam-controls').classList.remove('hidden');
    $('page-title').innerText = currentExam.title + (mode==='practice' ? " (Luy·ªán t·∫≠p)" : "");
    
    // Reset state
    userAnswers={}; flaggedQuestions=new Set();
    $('submit-btn').style.display = mode === 'exam' ? 'block' : 'none';
    $('timer').style.display = mode === 'exam' ? 'block' : 'none';

    renderQuestions(); 
    renderPalette(); 
    
    if(mode === 'exam') startTimer(currentExam.time*60);
    if(window.innerWidth<768) toggleSidebar();
}

function renderQuestions(){
    $('question-container').innerHTML = currentExam.questions.map((q,idx)=>`
        <div class="card p-6 mb-4 scroll-mt-16" id="q-${idx}">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs font-bold opacity-40 uppercase tracking-wide">C√¢u ${q.id}</span>
                <button onclick="toggleFlag(${idx})" class="opacity-30 hover:opacity-100 transition" id="flag-btn-${idx}">ÙÄãÉ</button>
            </div>
            <div class="exam-font mb-4">${q.text}</div>
            ${q.img ? `<img src="${APP_CONFIG.imgPath}${q.img}" class="block-img" loading="lazy">` : ''}
            ${q.type==='choice' ? renderChoices(q,idx) : renderInput(q,idx)}
            <div id="feedback-${idx}" class="hidden mt-4 p-3 rounded-lg text-sm bg-gray-100 dark:bg-gray-800"></div>
        </div>
    `).join('');
}

function renderChoices(q,idx){
    return `<div class="grid grid-cols-1 gap-1">${q.options.map((opt,i)=>`
        <div class="option-row group" id="opt-${idx}-${i}" onclick="selectAnswer(${idx},${i},this)">
            <div class="w-5 h-5 rounded-full border border-gray-400 mr-3 flex items-center justify-center text-[10px] font-bold shrink-0 transition group-hover:border-[var(--accent)] ${userAnswers[idx]===i?'bg-[var(--accent)] border-[var(--accent)] text-white':''}">${String.fromCharCode(65+i)}</div>
            <div class="text-sm">${opt}</div>
        </div>`).join('')}</div>`;
}

function renderInput(q,idx){
    return `<input type="text" class="input-field" placeholder="${q.placeholder}" onchange="inputAnswer(${idx},this.value)">`;
}

function renderPalette(){
    $('palette').innerHTML = currentExam.questions.map((_,idx)=>`<div class="q-cell" id="cell-${idx}" onclick="scrollToQuestion(${idx})">${idx+1}</div>`).join('');
}

function selectAnswer(qIdx, optIdx, el){
    if(currentMode === 'exam' && userAnswers[qIdx] !== undefined) {
        // In exam mode, just update selection UI
        const parent = el.parentElement;
        Array.from(parent.children).forEach(c => {
            c.classList.remove('selected');
            c.querySelector('div:first-child').className='w-5 h-5 rounded-full border border-gray-400 mr-3 flex items-center justify-center text-[10px] font-bold shrink-0 transition group-hover:border-[var(--accent)]';
        });
    }
    
    userAnswers[qIdx] = optIdx;
    
    // UI Update
    el.classList.add('selected');
    el.querySelector('div:first-child').className='w-5 h-5 rounded-full border border-[var(--accent)] bg-[var(--accent)] text-white mr-3 flex items-center justify-center text-[10px] font-bold shrink-0';
    $('cell-'+qIdx).classList.add('done');

    // Practice Mode Logic
    if(currentMode === 'practice'){
        checkAnswer(qIdx);
    }
}

function inputAnswer(qIdx, val){
    if(val.trim()){
        userAnswers[qIdx] = val; 
        $('cell-'+qIdx).classList.add('done');
        if(currentMode === 'practice') checkAnswer(qIdx);
    } else {
        delete userAnswers[qIdx]; 
        $('cell-'+qIdx).classList.remove('done');
    }
}

function checkAnswer(qIdx){
    const q = currentExam.questions[qIdx];
    const feedback = $(`feedback-${qIdx}`);
    feedback.classList.remove('hidden');
    
    let isCorrect = false;
    if(q.type === 'choice'){
        isCorrect = userAnswers[qIdx] === q.correct;
        const correctEl = $(`opt-${qIdx}-${q.correct}`);
        const selectedEl = $(`opt-${qIdx}-${userAnswers[qIdx]}`);
        
        if(correctEl) correctEl.classList.add('correct');
        if(!isCorrect && selectedEl) selectedEl.classList.add('wrong');
    } else {
        isCorrect = userAnswers[qIdx] == q.correct; // Loose equality for numbers
    }

    feedback.innerHTML = isCorrect 
        ? `<span class="text-green-600 font-bold">‚úì Ch√≠nh x√°c!</span>` 
        : `<span class="text-red-600 font-bold">‚úó Sai r·ªìi.</span> ƒê√°p √°n ƒë√∫ng l√†: ${q.type==='choice' ? String.fromCharCode(65+q.correct) : q.correct}`;
        
    // Update Palette Heatmap immediately in Practice Mode
    const cell = $(`cell-${qIdx}`);
    cell.classList.remove('done');
    cell.classList.add(isCorrect ? 'correct' : 'wrong');
}

function submitExam(){
    if(confirm('N·ªôp b√†i ngay?')){
        clearInterval(timerInterval);
        let score = 0;
        currentExam.questions.forEach((q, idx) => {
            let isCorrect = false;
            if(q.type === 'choice') isCorrect = userAnswers[idx] === q.correct;
            else isCorrect = userAnswers[idx] == q.correct;
            
            if(isCorrect) score++;
            
            // Heatmap Update
            const cell = $(`cell-${idx}`);
            cell.classList.remove('done');
            if(userAnswers[idx] === undefined) cell.style.background = '#e5e5ea'; // Skipped
            else cell.classList.add(isCorrect ? 'correct' : 'wrong');
            
            // Show feedback
            checkAnswer(idx);
        });
        
        alert(`K·∫øt qu·∫£: ${score}/${currentExam.questions.length} c√¢u ƒë√∫ng.`);
        $('submit-btn').style.display = 'none';
    }
}

function toggleFlag(idx){
    if(flaggedQuestions.has(idx)){
        flaggedQuestions.delete(idx);
        $('flag-btn-'+idx).classList.remove('text-yellow-500','opacity-100');
        $('cell-'+idx).classList.remove('flagged');
    }else{
        flaggedQuestions.add(idx);
        $('flag-btn-'+idx).classList.add('text-yellow-500','opacity-100');
        $('cell-'+idx).classList.add('flagged');
    }
}

function scrollToQuestion(idx){
    $('q-'+idx).scrollIntoView({behavior:'smooth',block:'center'});
}

function startTimer(sec){
    clearInterval(timerInterval);
    const d=$('timer');
    timerInterval=setInterval(()=>{
        const m=Math.floor(sec/60), s=sec%60;
        d.innerText=`${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        if(sec<=300) d.classList.add('text-red-500');
        if(sec===0){clearInterval(timerInterval); submitExam();}
        sec--;
    },1000);
}

if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
init();
</script>
</body>
</html>
